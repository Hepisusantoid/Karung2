<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Penjualan Karung – MT2 2025</title>
  <style>
    :root{
      --bg:#0b1220; --card:#0f172a; --muted:#94a3b8; --text:#e2e8f0;
      --primary:#0ea5e9; --primary-600:#0284c7; --green:#22c55e;
      --red:#ef4444; --yellow:#f59e0b; --violet:#8b5cf6;
    }
    *{box-sizing:border-box}
    body{
      margin:0;background:linear-gradient(180deg,#0b1220,#0b1220 40%,#0d1b2a 100%);
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;
      color:var(--text); padding:16px;
    }
    .container{
      max-width:980px;margin:0 auto;background:rgba(255,255,255,0.05);
      border:1px solid rgba(255,255,255,0.08); backdrop-filter: blur(6px);
      border-radius:18px; padding:18px 16px; box-shadow:0 20px 40px rgba(0,0,0,.35);
    }
    h1{margin:6px 0 14px; text-align:center; font-size:28px; letter-spacing:.5px}
    h2{margin:12px 0 10px; text-align:center; color:#c7d2fe}

    /* Top bar */
    .topbar{display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:space-between;margin-bottom:12px}
    .left{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .season-select{background:#0b1628;border:1px solid rgba(255,255,255,.12);color:var(--text);padding:10px;border-radius:10px}
    .auth-bar{display:flex;gap:10px;align-items:center}
    .auth-bar input{
      width:200px;background:#0b1628;border:1px solid rgba(255,255,255,0.12);
      color:var(--text); padding:10px 12px; border-radius:10px; outline:none;
    }
    .btn{
      padding:11px 14px; border:none; border-radius:12px; color:#fff; cursor:pointer;
      background: linear-gradient(180deg, var(--primary), var(--primary-600));
      box-shadow:0 10px 18px rgba(14,165,233,.25); transition:transform .06s ease,opacity .2s;
    }
    .btn.secondary{background:linear-gradient(180deg,#64748b,#475569); box-shadow:none}
    .btn:active{transform:translateY(1px)}
    .notice{min-height:18px;font-size:13px;color:#fca5a5}
    .notice.ok{color:#86efac}

    /* Tabs */
    .tabs{display:flex;gap:8px;flex-wrap:wrap;justify-content:center;margin:6px 0 12px}
    .tab{padding:9px 14px;border-radius:999px;border:1px solid rgba(255,255,255,.15);cursor:pointer}
    .tab.active{background:#0b1628}
    .section{display:none}
    .section.active{display:block}

    /* Form grid */
    .grid{display:grid;grid-template-columns:repeat(2,1fr);gap:14px}
    @media (max-width:640px){ .grid{grid-template-columns:1fr} }
    label{display:block;font-weight:700;margin-bottom:6px;color:#cbd5e1}
    input[type="text"], input[type="number"]{
      width:100%; padding:12px; border:1px solid rgba(255,255,255,.12);
      border-radius:12px; background:#0b1628; color:var(--text); font-size:15px;
    }
    .btn-row{display:flex;gap:12px;margin-top:12px}

    /* Kartu pembeli */
    .data-item{
      background:#0b1628; border:1px solid rgba(255,255,255,.08);
      border-left:6px solid var(--primary); border-radius:14px; padding:12px; margin:12px 0;
    }
    .lunas{border-left-color:var(--green)}
    .belum-lunas{border-left-color:var(--red)}
    .data-item p{margin:4px 0}
    .uang{font-weight:800; color:#93c5fd}
    .status-badge{
      display:inline-block; padding:3px 8px; border-radius:999px;
      font-size:12px; margin-left:6px; vertical-align:middle;
    }
    .status-lunas{background:rgba(34,197,94,.15); color:#86efac; border:1px solid rgba(34,197,94,.35)}
    .status-belum{background:rgba(239,68,68,.15); color:#fca5a5; border:1px solid rgba(239,68,68,.35)}

    /* Actions - sebaris & sama lebar */
    .btn-actions{
      display:flex; gap:8px; align-items:center; justify-content:space-between;
      margin-top:10px; flex-wrap:nowrap;
    }
    .btn-actions .btn{
      flex:1 1 0; min-width:0; border-radius:12px; padding:10px 8px; text-align:center; font-size:14px;
    }
    .btn-copy{background:linear-gradient(180deg,#94a3b8,#64748b)}
    .btn-yellow{background:linear-gradient(180deg,#fbbf24,#f59e0b); color:#1f2937}
    .btn-green{background:linear-gradient(180deg,#22c55e,#16a34a)}
    .btn-red{background:linear-gradient(180deg,#f87171,#ef4444)}
    .edit-fields{display:none;margin-top:10px}
    .edit-fields input{margin-bottom:8px}

    /* Laporan / Stok / Analitik */
    .panel{
      margin-top:16px; padding:16px; border-radius:16px;
      background:linear-gradient(180deg,rgba(139,92,246,.15),rgba(139,92,246,.08));
      border:1px solid rgba(139,92,246,.5);
    }
    .panel p{margin:6px 0}
    .stock-box{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .stock-now{font-weight:800;color:#86efac}
    .table{width:100%; border-collapse:collapse; margin-top:10px}
    .table th,.table td{border-bottom:1px solid rgba(255,255,255,.1); padding:8px; text-align:left; font-size:14px}
  </style>
</head>
<body>
<div class="container">

  <!-- Top bar -->
  <div class="topbar">
    <div class="left">
      <strong>Musim:</strong>
      <select id="season_select" class="season-select" onchange="changeSeason(this.value)"></select>
      <span id="season_info" class="muted"></span>
    </div>
    <div class="auth-bar">
      <input type="password" id="admin_pass" placeholder="Password admin"/>
      <button id="login_btn" class="btn" onclick="login()">Login</button>
      <button id="logout_btn" class="btn secondary" style="display:none" onclick="logout()">Keluar</button>
    </div>
  </div>
  <div id="auth_msg" class="notice"></div>

  <!-- Tabs -->
  <div class="tabs">
    <div class="tab active" data-tab="sales">Penjualan</div>
    <div class="tab" data-tab="stock">Stok</div>
    <div class="tab" data-tab="analytics">Analitik MOS</div>
    <div class="tab" data-tab="seasons">Musim</div>
  </div>

  <!-- PENJUALAN -->
  <section id="sales" class="section active">
    <h1>Penjualan – MT2 2025</h1>

    <!-- Form admin (muncul setelah login) -->
    <div id="admin_form" style="display:none">
      <div class="grid">
        <div>
          <label for="nama_pelanggan">Nama</label>
          <input type="text" id="nama_pelanggan" placeholder="cth: Hepi Susanto"/>
        </div>
        <div>
          <label for="kodi_terjual">Kodi</label>
          <input type="text" id="kodi_terjual" value="0"/>
        </div>
        <div>
          <label for="sudah_bayar">Bayar</label>
          <input type="text" id="sudah_bayar" value="0"/>
        </div>
        <div>
          <label for="harga_modal">Modal/Kodi</label>
          <input type="text" id="harga_modal" value="0"/>
        </div>
      </div>
      <div class="btn-row">
        <button class="btn" onclick="tambahData()">Tambah</button>
      </div>
    </div>

    <div id="hasil-penjualan">
      <h2>Daftar Penjualan</h2>
      <div id="daftar_penjualan"></div>
    </div>

    <!-- Laporan keuangan (hanya saat login) -->
    <div id="laporan-keuangan-container" style="display:none;">
      <div class="panel">
        <h2>Laporan Keuangan Musim Aktif</h2>
        <p><strong>Kodi Terjual:</strong> <span id="total_kodi">0</span> kodi</p>
        <p><strong>Omzet:</strong> <span id="omzet">Rp 0</span></p>
        <p><strong>Total Modal:</strong> <span id="total_modal">Rp 0</span></p>
        <p><strong>Laba Kotor:</strong> <span id="laba_kotor">Rp 0</span></p>
        <p><strong>Laba Bersih:</strong> <span id="laba_bersih">Rp 0</span></p>
      </div>
    </div>
  </section>

  <!-- STOK -->
  <section id="stock" class="section">
    <h1>Stok Musim Aktif</h1>
    <div class="panel">
      <div class="stock-box">
        <div>Stok Sekarang:</div>
        <div class="stock-now" id="stock_now">0 kodi</div>
      </div>
      <div class="btn-row" style="margin-top:10px">
        <input type="text" id="stok_tambah" placeholder="Tambah stok (kodi)"/>
        <button class="btn" onclick="tambahStokManual()">Tambah Stok</button>
      </div>
      <h3 style="margin-top:14px">Riwayat Stok</h3>
      <table class="table" id="stok_hist">
        <thead><tr><th>Waktu</th><th>Keterangan</th><th>Perubahan</th><th>Stok Akhir</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </section>

  <!-- ANALITIK -->
  <section id="analytics" class="section">
    <h1>Analitik – Break-Even & MOS</h1>
    <div class="panel">
      <div class="grid">
        <div>
          <label>Biaya Tetap (Fixed Costs) Musim ini</label>
          <input type="text" id="fixed_costs" value="0"/>
        </div>
        <div>
          <label>Harga per Kodi (referensi)</label>
          <input type="text" id="harga_kodi_ref" value="45.000" disabled/>
        </div>
      </div>
      <div class="btn-row">
        <button class="btn" onclick="simpanFixedCosts()">Simpan Biaya Tetap</button>
        <button class="btn secondary" onclick="hitungAnalitik()">Hitung Analitik</button>
      </div>

      <div style="margin-top:10px">
        <p><strong>Penjualan Aktual:</strong> <span id="ana_sales">Rp 0</span></p>
        <p><strong>Biaya Variabel (COGS):</strong> <span id="ana_cogs">Rp 0</span></p>
        <p><strong>Contribution Margin Ratio (CM%):</strong> <span id="ana_cmr">0%</span></p>
        <p><strong>Break-Even Sales:</strong> <span id="ana_bep_sales">Rp 0</span> (<span id="ana_bep_units">0</span> kodi)</p>
        <p><strong>Margin of Safety Ratio:</strong> <span id="ana_mos">0%</span></p>
        <p style="color:#94a3b8;font-size:13px;margin-top:6px">
          MOS = (Penjualan Aktual − Penjualan BEP) / Penjualan Aktual
        </p>
      </div>
    </div>
  </section>

  <!-- MUSIM -->
  <section id="seasons" class="section">
    <h1>Kelola Musim</h1>
    <div class="panel">
      <div class="grid">
        <div>
          <label>Musim Aktif</label>
          <select id="season_select_2" class="season-select" onchange="changeSeason(this.value)"></select>
        </div>
        <div>
          <label>Tambah Musim Baru</label>
          <select id="season_add">
            <option>MT1 2023</option>
            <option>MT2 2023</option>
            <option>MT1 2024</option>
            <option>MT2 2024</option>
            <option>MT1 2025</option>
            <option>MT2 2025</option>
          </select>
        </div>
      </div>
      <div class="btn-row">
        <button class="btn" onclick="buatMusimBaru()">Buat Musim</button>
      </div>
      <p style="margin-top:10px;color:#94a3b8">Catatan: data lama otomatis dimasukkan ke <strong>MT2 2025</strong> saat migrasi.</p>
    </div>
  </section>

</div>

<script>
  /* ======================= KONFIG & STATE ======================= */
  const HARGA_PER_KODI_GLOBAL = 45000; // referensi
  let record = {};              // seluruh isi BIN (schema baru)
  let activeSeasonKey = "MT2 2025";

  /* ===== Util angka ===== */
  const fmt = n => (n==null||isNaN(n)) ? "0" : n.toString().replace(/\B(?=(\d{3})+(?!\d))/g,".");
  const parseNum = s => parseInt(String(s||"0").replace(/\./g,""))||0;
  const nowID = () => new Date().toLocaleString("id-ID");

  // format input angka
  function wireNumberFormatting(){
    ["kodi_terjual","sudah_bayar","harga_modal","stok_tambah","fixed_costs"].forEach(id=>{
      const el=document.getElementById(id); if(!el) return;
      el.addEventListener("input",()=>{ el.value = fmt(parseNum(el.value)); });
    });
  }

  /* ===== Auth (validasi ke server) ===== */
  const isLoggedIn = () => !!localStorage.getItem("authToken");
  const getToken   = () => localStorage.getItem("authToken")||"";
  const setNotice  = (msg, ok=false) => { const m=document.getElementById("auth_msg"); m.textContent=msg||""; m.className="notice"+(ok?" ok":""); };

  async function login(){
    const pass = document.getElementById("admin_pass").value.trim();
    if(!pass){ setNotice("Masukkan password admin."); return; }
    setNotice("Memeriksa…");
    try{
      const res = await fetch("/api/auth",{method:"POST",headers:{Authorization:"Bearer "+pass}});
      if(res.ok){
        localStorage.setItem("authToken", pass);
        document.getElementById("admin_pass").value="";
        setNotice("Login berhasil.", true);
        updateAuthUI(); renderAll();
      }else{
        localStorage.removeItem("authToken");
        setNotice("Password salah.");
        updateAuthUI();
      }
    }catch(e){ setNotice("Gagal terhubung server."); }
  }
  function logout(){ localStorage.removeItem("authToken"); setNotice("Anda keluar."); updateAuthUI(); renderAll(); }

  function updateAuthUI(){
    const on=isLoggedIn();
    document.getElementById("login_btn").style.display=on?"none":"inline-block";
    document.getElementById("logout_btn").style.display=on?"inline-block":"none";
    document.getElementById("admin_form").style.display=on?"block":"none";
    document.getElementById("laporan-keuangan-container").style.display=on?"block":"none";
    document.querySelectorAll(".admin-only").forEach(n=> n.style.display = on ? "" : "none");
  }

  /* ===== Data helpers ===== */
  const emptySeason = () => ({
    customers:{},                // { nama: {kodi_terjual,pembayaran_awal,harga_modal,tanggal_update} }
    stock_current: 0,            // kodi
    stock_history: [],           // [{time, note, delta, balance}]
    fixed_costs: 0               // rupiah
  });

  const seasons = () => record.seasons || (record.seasons={});
  const season  = () => seasons()[activeSeasonKey] || (seasons()[activeSeasonKey]=emptySeason());

  function loadSeasonSelectors(){
    const keys = Object.keys(seasons()).sort();
    const sel1 = document.getElementById("season_select");
    const sel2 = document.getElementById("season_select_2");
    [sel1, sel2].forEach(sel=>{
      sel.innerHTML = keys.map(k=>`<option ${k===activeSeasonKey?"selected":""}>${k}</option>`).join("");
    });
    document.getElementById("season_info").textContent = `Aktif: ${activeSeasonKey}`;
    document.querySelector("#sales h1").textContent = `Penjualan – ${activeSeasonKey}`;
  }

  function changeSeason(key){ activeSeasonKey = key; renderAll(); }

  /* ===== API proxy via Vercel ===== */
  async function muatData(){
    try{
      const res = await fetch("/api/get");
      const raw = await res.json();
      // MIGRASI: jika format lama (langsung daftar pelanggan), bungkus ke seasons["MT2 2025"]
      if(!raw || typeof raw !== "object"){ record = {seasons:{}}; }
      else if(!raw.seasons){
        record = { seasons: { "MT2 2025": { ...emptySeason(), customers: raw } } };
      }else{
        record = raw;
      }
      // inisialisasi musim penting bila belum ada
      ["MT1 2023","MT2 2023","MT1 2024","MT2 2024","MT1 2025","MT2 2025"].forEach(k=>{
        if(!seasons()[k]) seasons()[k]=emptySeason();
      });
      renderAll();
    }catch(e){ console.error("Gagal muat:", e); alert("Gagal memuat data."); }
  }

  async function simpanRecord(){
    if(!isLoggedIn()){ alert("Login dulu untuk menyimpan."); return; }
    try{
      const r = await fetch("/api/update",{
        method:"PUT",
        headers:{ "Content-Type":"application/json", "Authorization":"Bearer "+getToken() },
        body: JSON.stringify({ record })
      });
      if(!r.ok){ alert("Gagal menyimpan data."); }
    }catch(e){ alert("Gagal menyimpan data."); }
  }

  /* ======================= PENJUALAN ======================= */
  function daftarPelanggan(){ return season().customers; }

  // urut: belum lunas di atas
  function sortedEntries(){
    return Object.keys(daftarPelanggan()).map(n=>({nama:n, data:daftarPelanggan()[n]})).sort((a,b)=>{
      const sA = (a.data.kodi_terjual*HARGA_PER_KODI_GLOBAL)-a.data.pembayaran_awal;
      const sB = (b.data.kodi_terjual*HARGA_PER_KODI_GLOBAL)-b.data.pembayaran_awal;
      if(sA>0 && sB<=0) return -1; if(sA<=0 && sB>0) return 1; return 0;
    });
  }

  function tambahData(){
    if(!isLoggedIn()){ alert("Login dulu."); return; }
    const nama  = document.getElementById("nama_pelanggan").value.trim();
    const kodi  = parseNum(document.getElementById("kodi_terjual").value);
    const bayar = parseNum(document.getElementById("sudah_bayar").value);
    const modal = parseNum(document.getElementById("harga_modal").value);
    if(!nama || kodi<=0){ alert("Isi nama & kodi valid."); return; }

    // cek stok
    if(season().stock_current < kodi){
      alert("Stok tidak cukup. Tambah stok dulu di tab STOK.");
      return;
    }

    daftarPelanggan()[nama] = {kodi_terjual:kodi,pembayaran_awal:bayar,harga_modal:modal,tanggal_update:nowID()};
    // kurangi stok + catat
    season().stock_current -= kodi;
    season().stock_history.push({time:nowID(), note:`Penjualan ${nama}`, delta:-kodi, balance:season().stock_current});

    simpanRecord(); renderAll();

    ["nama_pelanggan","kodi_terjual","sudah_bayar","harga_modal"].forEach(id=>document.getElementById(id).value = id==="nama_pelanggan"?"":"0");
  }

  function toggleEdit(nama){
    if(!isLoggedIn()){ alert("Login dulu untuk edit."); return; }
    const card = document.querySelector(`.data-item[data-nama="${nama}"]`);
    card.querySelector(".edit-fields").style.display="block";
    card.querySelector(".btn-edit").style.display="none";
    card.querySelector(".btn-save").style.display="inline-block";
  }

  function simpanEdit(nama){
    if(!isLoggedIn()){ alert("Login dulu untuk simpan."); return; }
    const card = document.querySelector(`.data-item[data-nama="${nama}"]`);
    const baruKodi  = parseNum(card.querySelector(".edit-kodi").value);
    const baruBayar = parseNum(card.querySelector(".edit-bayar").value);
    const baruModal = parseNum(card.querySelector(".edit-modal").value);

    if(baruKodi<=0){ alert("Kodi harus > 0"); return; }

    const lamaKodi = daftarPelanggan()[nama].kodi_terjual;
    const diff = baruKodi - lamaKodi; // + berarti tambah ambil stok; - berarti kembalikan stok
    if(diff>0 && season().stock_current < diff){
      alert("Stok tidak cukup untuk penyesuaian kodi. Tambah stok di tab STOK.");
      return;
    }
    // adjust stok & catat
    if(diff!==0){
      season().stock_current -= diff;
      season().stock_history.push({time:nowID(), note:`Edit penjualan ${nama} (${diff>0?"+":""}${diff} kodi)`, delta:-diff, balance:season().stock_current});
    }

    daftarPelanggan()[nama] = {kodi_terjual:baruKodi,pembayaran_awal:baruBayar,harga_modal:baruModal,tanggal_update:nowID()};
    simpanRecord(); renderAll();
  }

  function hapusData(nama){
    if(!isLoggedIn()){ alert("Login dulu untuk hapus."); return; }
    if(!confirm(`Hapus data ${nama}?`)) return;
    const k = daftarPelanggan()[nama]?.kodi_terjual || 0;
    delete daftarPelanggan()[nama];
    // kembalikan stok
    season().stock_current += k;
    season().stock_history.push({time:nowID(), note:`Hapus penjualan ${nama}`, delta:+k, balance:season().stock_current});

    simpanRecord(); renderAll();
  }

  function copyData(nama){
    const d = daftarPelanggan()[nama];
    const totalTagihan = d.kodi_terjual * HARGA_PER_KODI_GLOBAL;
    const sisaUtang    = totalTagihan - d.pembayaran_awal;
    const status       = sisaUtang>0 ? "Belum Lunas" : "Lunas";
    const text =
`Nama: ${nama}
Kodi: ${d.kodi_terjual}
Total Bayar: Rp ${fmt(totalTagihan)}
Sudah Bayar: Rp ${fmt(d.pembayaran_awal)}
Sisa Utang: Rp ${fmt(sisaUtang)}
Status: ${status}
Tanggal Update: ${d.tanggal_update || "-"}`;
    navigator.clipboard?.writeText(text).then(()=>alert("Data disalin."));
  }

  /* ======================= STOK ======================= */
  function tambahStokManual(){
    if(!isLoggedIn()){ alert("Login dulu."); return; }
    const tambah = parseNum(document.getElementById("stok_tambah").value);
    if(tambah<=0){ alert("Masukkan jumlah stok yang valid."); return; }
    season().stock_current += tambah;
    season().stock_history.push({time:nowID(), note:"Tambah stok manual", delta:+tambah, balance:season().stock_current});
    document.getElementById("stok_tambah").value = "0";
    simpanRecord(); renderAll();
  }

  /* ======================= ANALITIK MOS ======================= */
  function simpanFixedCosts(){
    if(!isLoggedIn()){ alert("Login dulu."); return; }
    season().fixed_costs = parseNum(document.getElementById("fixed_costs").value);
    simpanRecord(); hitungAnalitik();
  }

  function hitungAnalitik(){
    const {sales, cogs, cmr, bepSales, bepUnits, mos} = kalkulasiMusim();
    document.getElementById("ana_sales").textContent    = "Rp " + fmt(sales);
    document.getElementById("ana_cogs").textContent     = "Rp " + fmt(cogs);
    document.getElementById("ana_cmr").textContent      = (cmr>0? (cmr*100).toFixed(1):0) + "%";
    document.getElementById("ana_bep_sales").textContent= "Rp " + (bepSales===null?"0":fmt(Math.round(bepSales)));
    document.getElementById("ana_bep_units").textContent= bepUnits===null? "0" : fmt(Math.ceil(bepUnits));
    document.getElementById("ana_mos").textContent      = mos===null? "0%" : ((mos*100).toFixed(1)+"%");
  }

  function kalkulasiMusim(){
    const items = Object.values(daftarPelanggan());
    const totalKodi = items.reduce((s,d)=>s+d.kodi_terjual,0);
    const sales = totalKodi * HARGA_PER_KODI_GLOBAL;
    const cogs  = items.reduce((s,d)=>s + d.kodi_terjual*(d.harga_modal||0),0);
    const cm    = sales - cogs;
    const cmr   = sales>0 ? cm/sales : 0; // contribution margin ratio
    const FC    = season().fixed_costs || 0;
    const bepSales = cmr>0 ? FC / cmr : null;
    const bepUnits = cmr>0 ? bepSales / HARGA_PER_KODI_GLOBAL : null;
    const mos      = (sales>0 && bepSales!=null) ? (sales - bepSales)/sales : null;
    return {sales,cogs,cmr,bepSales,bepUnits,mos,totalKodi};
  }

  /* ======================= RENDER ======================= */
  function renderSales(){
    const wrap = document.getElementById("daftar_penjualan");
    wrap.innerHTML = "";
    let totalOmzet=0, totalUtang=0, totalModal=0, totalKodi=0;

    sortedEntries().forEach(({nama,data})=>{
      const totalTagihan = data.kodi_terjual * HARGA_PER_KODI_GLOBAL;
      const sisaUtang = totalTagihan - data.pembayaran_awal;
      const statusClass = sisaUtang>0 ? "belum-lunas" : "lunas";
      const statusText  = sisaUtang>0 ? "Belum Lunas" : "Lunas";

      totalKodi  += data.kodi_terjual;
      totalOmzet += totalTagihan;
      totalUtang += sisaUtang;
      totalModal += data.kodi_terjual * (data.harga_modal||0);

      const el = document.createElement("div");
      el.className = `data-item ${statusClass}`;
      el.setAttribute("data-nama", nama);
      el.innerHTML = `
        <p><strong>Nama:</strong> ${nama}</p>
        <p><strong>Kodi:</strong> ${fmt(data.kodi_terjual)}</p>
        <p><strong>Total Bayar:</strong> <span class="uang">Rp ${fmt(totalTagihan)}</span></p>
        <p><strong>Sudah Bayar:</strong> <span class="uang">Rp ${fmt(data.pembayaran_awal)}</span></p>
        <p><strong>Sisa Utang:</strong> <span class="uang">Rp ${fmt(sisaUtang)}</span>
           <span class="status-badge ${statusText==='Lunas'?'status-lunas':'status-belum'}">${statusText}</span></p>
        <p><strong>Tanggal Update:</strong> ${data.tanggal_update || "-"}</p>

        <div class="btn-actions">
          <button class="btn btn-copy" onclick="copyData('${nama}')">Salin</button>

          <button class="btn btn-yellow btn-edit admin-only"
                  style="${isLoggedIn()?'':'display:none'}"
                  onclick="toggleEdit('${nama}')">Edit</button>

          <button class="btn btn-green btn-save"
                  style="display:none"
                  onclick="simpanEdit('${nama}')">Simpan</button>

          <button class="btn btn-red btn-delete admin-only"
                  style="${isLoggedIn()?'':'display:none'}"
                  onclick="hapusData('${nama}')">Hapus</button>
        </div>

        <div class="edit-fields">
          <input type="text" class="edit-kodi"  value="${fmt(data.kodi_terjual)}" placeholder="Kodi"/>
          <input type="text" class="edit-bayar" value="${fmt(data.pembayaran_awal)}" placeholder="Sudah Bayar"/>
          <input type="text" class="edit-modal" value="${fmt(data.harga_modal||0)}" placeholder="Modal/Kodi"/>
        </div>
      `;
      wrap.appendChild(el);

      el.querySelectorAll(".edit-kodi,.edit-bayar,.edit-modal").forEach(inp=>{
        inp.addEventListener("input", ()=>{ inp.value = fmt(parseNum(inp.value)); });
      });
    });

    // laporan keuangan (login saja)
    if(isLoggedIn()){
      const labaKotor = totalOmzet - totalModal;
      const labaBersih = labaKotor - totalUtang;
      document.getElementById("total_kodi").textContent = fmt(totalKodi);
      document.getElementById("omzet").textContent      = "Rp " + fmt(totalOmzet);
      document.getElementById("total_modal").textContent= "Rp " + fmt(totalModal);
      document.getElementById("laba_kotor").textContent = "Rp " + fmt(labaKotor);
      document.getElementById("laba_bersih").textContent= "Rp " + fmt(labaBersih);
    }
  }

  function renderStock(){
    document.getElementById("stock_now").textContent = fmt(season().stock_current) + " kodi";
    const tbody = document.querySelector("#stok_hist tbody");
    tbody.innerHTML = season().stock_history.slice().reverse().slice(0,15).map(h=>`
      <tr><td>${h.time}</td><td>${h.note}</td><td>${h.delta>0?"+":""}${fmt(h.delta)} kodi</td><td>${fmt(h.balance)} kodi</td></tr>
    `).join("");
  }

  function renderAnalytics(){
    document.getElementById("fixed_costs").value    = fmt(season().fixed_costs||0);
    document.getElementById("harga_kodi_ref").value = fmt(HARGA_PER_KODI_GLOBAL);
    hitungAnalitik();
  }

  function renderSeasonControls(){
    loadSeasonSelectors();
  }

  function renderAll(){
    updateAuthUI();
    renderSeasonControls();
    renderSales();
    renderStock();
    renderAnalytics();
  }

  /* ======================= MUSIM ======================= */
  function buatMusimBaru(){
    const key = document.getElementById("season_add").value;
    if(!seasons()[key]) seasons()[key]=emptySeason();
    activeSeasonKey = key;
    simpanRecord(); renderAll();
  }

  /* ======================= Tabs ======================= */
  document.querySelectorAll(".tab").forEach(t=>{
    t.addEventListener("click", ()=>{
      document.querySelectorAll(".tab").forEach(el=>el.classList.remove("active"));
      document.querySelectorAll(".section").forEach(el=>el.classList.remove("active"));
      t.classList.add("active");
      document.getElementById(t.dataset.tab).classList.add("active");
    });
  });

  // init
  wireNumberFormatting();
  muatData();
</script>
</body>
</html>

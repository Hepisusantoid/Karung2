<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Pelacakan Penjualan Karung Gadu 2025</title>
  <style>
    :root{
      --bg:#0b1220; --card:#0f172a; --muted:#94a3b8; --text:#e2e8f0;
      --primary:#0ea5e9; --primary-600:#0284c7; --green:#22c55e;
      --red:#ef4444; --yellow:#f59e0b; --violet:#8b5cf6;
    }
    *{box-sizing:border-box}
    body{
      margin:0;background:linear-gradient(180deg,#0b1220,#0b1220 40%,#0d1b2a 100%);
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;
      color:var(--text); padding:16px;
    }
    .container{
      max-width:880px;margin:0 auto;background:rgba(255,255,255,0.05);
      border:1px solid rgba(255,255,255,0.08); backdrop-filter: blur(6px);
      border-radius:18px; padding:18px 16px; box-shadow:0 20px 40px rgba(0,0,0,.35);
    }
    h1{margin:6px 0 14px; text-align:center; font-size:28px; letter-spacing:.5px}
    h2{margin:12px 0 10px; text-align:center; color:#c7d2fe}

    /* Auth */
    .auth-bar{display:flex;gap:10px;justify-content:flex-end;align-items:center;flex-wrap:wrap;margin-bottom:10px}
    .auth-bar input{
      flex:1 1 220px;background:#0b1628;border:1px solid rgba(255,255,255,0.12);
      color:var(--text); padding:10px 12px; border-radius:10px; outline:none;
    }
    .btn{
      padding:11px 14px; border:none; border-radius:12px; color:#fff; cursor:pointer;
      background: linear-gradient(180deg, var(--primary), var(--primary-600));
      box-shadow:0 10px 18px rgba(14,165,233,.25); transition:transform .06s ease,opacity .2s;
    }
    .btn.secondary{background:linear-gradient(180deg,#64748b,#475569); box-shadow:none}
    .btn:active{transform:translateY(1px)}
    .auth-msg{min-height:18px;font-size:13px;margin-left:auto;color:#fca5a5}
    .auth-msg.ok{color:#86efac}

    /* Form grid */
    .grid{display:grid;grid-template-columns:repeat(2,1fr);gap:14px}
    @media (max-width:560px){ .grid{grid-template-columns:1fr} }
    label{display:block;font-weight:700;margin-bottom:6px;color:#cbd5e1}
    input[type="text"]{
      width:100%; padding:12px; border:1px solid rgba(255,255,255,.12);
      border-radius:12px; background:#0b1628; color:var(--text); font-size:15px;
    }
    .btn-row{display:flex;gap:12px;margin-top:12px}

    /* Kartu pembeli */
    .data-item{
      background:#0b1628; border:1px solid rgba(255,255,255,.08);
      border-left:6px solid var(--primary); border-radius:14px; padding:12px; margin:12px 0;
    }
    .lunas{border-left-color:var(--green)}
    .belum-lunas{border-left-color:var(--red)}
    .data-item p{margin:4px 0}
    .uang{font-weight:800; color:#93c5fd}
    .status-badge{
      display:inline-block; padding:3px 8px; border-radius:999px;
      font-size:12px; margin-left:6px; vertical-align:middle;
    }
    .status-lunas{background:rgba(34,197,94,.15); color:#86efac; border:1px solid rgba(34,197,94,.35)}
    .status-belum{background:rgba(239,68,68,.15); color:#fca5a5; border:1px solid rgba(239,68,68,.35)}

    /* Actions - sebaris & sama lebar */
    .btn-actions{
      display:flex; gap:8px; align-items:center; justify-content:space-between;
      margin-top:10px; flex-wrap:nowrap;
    }
    .btn-actions .btn{
      flex:1 1 0; min-width:0; border-radius:12px; padding:10px 8px; text-align:center; font-size:14px;
    }
    .btn-copy{background:linear-gradient(180deg,#94a3b8,#64748b)}
    .btn-yellow{background:linear-gradient(180deg,#fbbf24,#f59e0b); color:#1f2937}
    .btn-green{background:linear-gradient(180deg,#22c55e,#16a34a)}
    .btn-red{background:linear-gradient(180deg,#f87171,#ef4444)}
    .edit-fields{display:none;margin-top:10px}
    .edit-fields input{margin-bottom:8px}

    /* Laporan */
    .laporan{
      margin-top:16px; padding:16px; border-radius:16px;
      background:linear-gradient(180deg,rgba(139,92,246,.15),rgba(139,92,246,.08));
      border:1px solid rgba(139,92,246,.5);
    }
    .laporan p{margin:6px 0}
  </style>
</head>
<body>
<div class="container">

  <!-- LOGIN -->
  <div class="auth-bar">
    <input type="password" id="admin_pass" placeholder="Password admin (untuk ubah data)"/>
    <button id="login_btn" class="btn" onclick="login()">Login</button>
    <button id="logout_btn" class="btn secondary" style="display:none" onclick="logout()">Keluar</button>
    <span id="auth_msg" class="auth-msg"></span>
  </div>

  <h1>Gadu 2025</h1>

  <!-- FORM ADMIN (muncul hanya setelah login) -->
  <div id="admin_form" style="display:none">
    <div class="grid">
      <div>
        <label for="nama_pelanggan">Nama</label>
        <input type="text" id="nama_pelanggan" placeholder="cth: Hepi Susanto"/>
      </div>
      <div>
        <label for="kodi_terjual">Kodi</label>
        <input type="text" id="kodi_terjual" value="0"/>
      </div>
      <div>
        <label for="sudah_bayar">Bayar</label>
        <input type="text" id="sudah_bayar" value="0"/>
      </div>
      <div>
        <label for="harga_modal">Modal/Kodi</label>
        <input type="text" id="harga_modal" value="0"/>
      </div>
    </div>
    <div class="btn-row">
      <button class="btn" onclick="tambahData()">Tambah</button>
    </div>
  </div>

  <div id="hasil-penjualan">
    <h2>Laporan Penjualan</h2>
    <div id="daftar_penjualan"></div>
  </div>

  <!-- LAPORAN KEUANGAN (disembunyikan jika belum login) -->
  <div id="laporan-keuangan-container" style="display:none;">
    <div class="laporan">
      <h2>Laporan Keuangan</h2>
      <p><strong>Kodi Terjual:</strong> <span id="total_kodi">0</span> kodi</p>
      <p><strong>Omzet:</strong> <span id="omzet">Rp 0</span></p>
      <p><strong>Total Modal:</strong> <span id="total_modal">Rp 0</span></p>
      <p><strong>Laba Kotor:</strong> <span id="laba_kotor">Rp 0</span></p>
      <p><strong>Laba Bersih:</strong> <span id="laba_bersih">Rp 0</span></p>
    </div>
  </div>

</div>

<script>
  const hargaPerKodi = 45000;
  let dataPelanggan = {};

  /* ===== Util angka ===== */
  function formatNumber(num){ if(num==null||isNaN(num)) return "0"; return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g,"."); }
  function parseNumber(str){ return parseInt((str||"0").replace(/\./g,""))||0; }

  // Auto-format untuk input angka
  function wireNumberFormatting(){
    ["kodi_terjual","sudah_bayar","harga_modal"].forEach(id=>{
      const el=document.getElementById(id); if(!el) return;
      el.addEventListener("input",()=>{ el.value = formatNumber(parseNumber(el.value)); });
    });
  }

  /* ===== Auth sederhana (password divalidasi ke server) ===== */
  function setAuthMsg(msg, ok=false){
    const m=document.getElementById("auth_msg");
    m.textContent = msg || "";
    m.className = "auth-msg" + (ok ? " ok":"");
  }
  function isLoggedIn(){ return !!localStorage.getItem("authToken"); }
  function getToken(){ return localStorage.getItem("authToken")||""; }

  async function login(){
    const pass = document.getElementById("admin_pass").value.trim();
    if(!pass){ setAuthMsg("Masukkan password admin."); return; }
    setAuthMsg("Memeriksa...");
    try{
      // validasi ke server (endpoint ringan)
      const res = await fetch("/api/auth", { method:"POST", headers:{ "Authorization":"Bearer "+pass } });
      if(res.ok){
        localStorage.setItem("authToken", pass);
        document.getElementById("admin_pass").value="";
        setAuthMsg("Login berhasil.", true);
        updateAuthUI(); tampilkanLaporan();
      }else{
        localStorage.removeItem("authToken");
        setAuthMsg("Password salah. Coba lagi.");
        updateAuthUI();
      }
    }catch(e){
      localStorage.removeItem("authToken");
      setAuthMsg("Gagal terhubung ke server.");
      updateAuthUI();
    }
  }

  function logout(){
    localStorage.removeItem("authToken");
    setAuthMsg("Anda telah keluar.");
    updateAuthUI(); tampilkanLaporan();
  }

  function updateAuthUI(){
    const logged = isLoggedIn();
    document.getElementById("admin_form").style.display = logged ? "block":"none";
    document.getElementById("login_btn").style.display = logged ? "none":"inline-block";
    document.getElementById("logout_btn").style.display = logged ? "inline-block":"none";
    // Tampilkan/ sembunyikan elemen admin-only (kecuali tombol Simpan)
    document.querySelectorAll(".admin-only").forEach(n=> n.style.display = logged ? "" : "none");
    // Laporan keuangan hanya saat login
    document.getElementById("laporan-keuangan-container").style.display = logged ? "block" : "none";
  }

  /* ===== API proxy via Vercel ===== */
  async function muatData(){
    try{
      const res = await fetch("/api/get");
      const record = await res.json();
      dataPelanggan = record || {};
      // tanggal fallback untuk data lama
      Object.keys(dataPelanggan).forEach(n=>{
        if(!dataPelanggan[n].tanggal_update) dataPelanggan[n].tanggal_update = "-";
      });
      tampilkanLaporan();
    }catch(e){
      console.error("Gagal muat:", e); alert("Gagal memuat data.");
    }
  }
  async function simpanData(){
    if(!isLoggedIn()){ alert("Silakan login dulu untuk menyimpan."); return; }
    try{
      const res = await fetch("/api/update",{
        method:"PUT",
        headers:{
          "Content-Type":"application/json",
          "Authorization":"Bearer "+getToken()
        },
        body: JSON.stringify({ record: dataPelanggan })
      });
      if(res.status===401||res.status===403){ alert("Password admin salah / tidak berhak."); return; }
      if(!res.ok){ console.error(await res.text()); alert("Gagal menyimpan data."); }
    }catch(e){ console.error(e); alert("Gagal menyimpan data."); }
  }

  /* ===== Fitur aplikasi (konsisten) ===== */
  function tambahData(){
    if(!isLoggedIn()){ alert("Login dulu untuk menambah data."); return; }
    const nama = document.getElementById("nama_pelanggan").value.trim();
    const kodi = parseNumber(document.getElementById("kodi_terjual").value);
    const bayar = parseNumber(document.getElementById("sudah_bayar").value);
    const modal = parseNumber(document.getElementById("harga_modal").value);
    if(!nama || kodi<=0){ alert("Isi nama & kodi yang valid."); return; }

    dataPelanggan[nama] = {
      kodi_terjual: kodi,
      pembayaran_awal: bayar,
      harga_modal: modal,
      tanggal_update: new Date().toLocaleString("id-ID")
    };
    simpanData();
    tampilkanLaporan();

    document.getElementById("nama_pelanggan").value="";
    document.getElementById("kodi_terjual").value="0";
    document.getElementById("sudah_bayar").value="0";
    document.getElementById("harga_modal").value="0";
  }

  function copyData(nama){
    const d = dataPelanggan[nama];
    const totalTagihan = d.kodi_terjual * hargaPerKodi;
    const sisaUtang = totalTagihan - d.pembayaran_awal;
    const status = sisaUtang>0 ? "Belum Lunas" : "Lunas";
    const text =
`Nama: ${nama}
Kodi: ${d.kodi_terjual}
Total Bayar: Rp ${formatNumber(totalTagihan)}
Sudah Bayar: Rp ${formatNumber(d.pembayaran_awal)}
Sisa Utang: Rp ${formatNumber(sisaUtang)}
Status: ${status}
Tanggal Update: ${d.tanggal_update || "-"}`;
    navigator.clipboard?.writeText(text)
      .then(()=>alert("Data disalin ke clipboard."))
      .catch(()=>{
        const ta=document.createElement("textarea"); ta.value=text; document.body.appendChild(ta);
        ta.select(); document.execCommand("copy"); document.body.removeChild(ta);
        alert("Data disalin ke clipboard.");
      });
  }

  function tampilkanLaporan(){
    const wrap = document.getElementById("daftar_penjualan");
    wrap.innerHTML = "";

    let totalOmzet=0, totalUtang=0, totalModal=0, totalKodi=0;

    const arr = Object.keys(dataPelanggan).map(k=>({nama:k, data:dataPelanggan[k]}));
    // Belum lunas di atas
    arr.sort((a,b)=>{
      const sA = (a.data.kodi_terjual*hargaPerKodi)-a.data.pembayaran_awal;
      const sB = (b.data.kodi_terjual*hargaPerKodi)-b.data.pembayaran_awal;
      if(sA>0 && sB<=0) return -1;
      if(sA<=0 && sB>0) return 1;
      return 0;
    });

    arr.forEach(({nama,data})=>{
      const totalTagihan = data.kodi_terjual * hargaPerKodi;
      const sisaUtang = totalTagihan - data.pembayaran_awal;
      const statusClass = sisaUtang>0 ? "belum-lunas":"lunas";
      const statusText  = sisaUtang>0 ? "Belum Lunas":"Lunas";

      totalKodi  += data.kodi_terjual;
      totalOmzet += totalTagihan;
      totalUtang += sisaUtang;
      totalModal += data.kodi_terjual * data.harga_modal;

      const el = document.createElement("div");
      el.className = `data-item ${statusClass}`;
      el.setAttribute("data-nama", nama);
      el.innerHTML = `
        <p><strong>Nama:</strong> ${nama}</p>
        <p><strong>Kodi:</strong> ${formatNumber(data.kodi_terjual)}</p>
        <p><strong>Total Bayar:</strong> <span class="uang">Rp ${formatNumber(totalTagihan)}</span></p>
        <p><strong>Sudah Bayar:</strong> <span class="uang">Rp ${formatNumber(data.pembayaran_awal)}</span></p>
        <p><strong>Sisa Utang:</strong> <span class="uang">Rp ${formatNumber(sisaUtang)}</span>
           <span class="status-badge ${statusText==='Lunas'?'status-lunas':'status-belum'}">${statusText}</span></p>
        <p><strong>Tanggal Update:</strong> ${data.tanggal_update || "-"}</p>

        <div class="btn-actions">
          <button class="btn btn-copy" onclick="copyData('${nama}')">Salin</button>

          <button class="btn btn-yellow btn-edit admin-only"
                  style="${isLoggedIn()?'':'display:none'}"
                  onclick="toggleEdit('${nama}')">Edit</button>

          <!-- Simpan: tidak punya class admin-only supaya tetap tersembunyi saat tidak edit -->
          <button class="btn btn-green btn-save"
                  style="display:none"
                  onclick="simpanEdit('${nama}')">Simpan</button>

          <button class="btn btn-red btn-delete admin-only"
                  style="${isLoggedIn()?'':'display:none'}"
                  onclick="hapusData('${nama}')">Hapus</button>
        </div>

        <div class="edit-fields">
          <input type="text" class="edit-kodi"  value="${formatNumber(data.kodi_terjual)}" placeholder="Kodi"/>
          <input type="text" class="edit-bayar" value="${formatNumber(data.pembayaran_awal)}" placeholder="Sudah Bayar"/>
          <input type="text" class="edit-modal" value="${formatNumber(data.harga_modal)}" placeholder="Modal/Kodi"/>
        </div>
      `;
      wrap.appendChild(el);

      // format saat edit (kartu)
      el.querySelectorAll(".edit-kodi,.edit-bayar,.edit-modal").forEach(inp=>{
        inp.addEventListener("input", ()=>{ inp.value = formatNumber(parseNumber(inp.value)); });
      });
    });

    const labaKotor = totalOmzet - totalModal;
    const labaBersih = labaKotor - totalUtang;

    const logged = isLoggedIn();
    document.getElementById("laporan-keuangan-container").style.display = logged ? "block":"none";
    if(logged){
      document.getElementById("total_kodi").innerText  = formatNumber(totalKodi);
      document.getElementById("omzet").innerText       = "Rp " + formatNumber(totalOmzet);
      document.getElementById("total_modal").innerText = "Rp " + formatNumber(totalModal);
      document.getElementById("laba_kotor").innerText  = "Rp " + formatNumber(labaKotor);
      document.getElementById("laba_bersih").innerText = "Rp " + formatNumber(labaBersih);
    }

    updateAuthUI(); // sinkron tombol admin-only setelah render
  }

  function toggleEdit(nama){
    if(!isLoggedIn()){ alert("Login dulu untuk mengedit."); return; }
    const card = document.querySelector(`.data-item[data-nama="${nama}"]`);
    card.querySelector(".edit-fields").style.display="block";
    const btnEdit = card.querySelector(".btn-edit");
    const btnSave = card.querySelector(".btn-save");
    if (btnEdit) btnEdit.style.display="none";
    if (btnSave) btnSave.style.display="inline-block";
  }

  function simpanEdit(nama){
    if(!isLoggedIn()){ alert("Login dulu untuk menyimpan."); return; }
    const card = document.querySelector(`.data-item[data-nama="${nama}"]`);
    const kodiBaru  = parseNumber(card.querySelector(".edit-kodi").value);
    const bayarBaru = parseNumber(card.querySelector(".edit-bayar").value);
    const modalBaru = parseNumber(card.querySelector(".edit-modal").value);
    if(kodiBaru<=0){ alert("Kodi harus > 0"); return; }

    dataPelanggan[nama].kodi_terjual    = kodiBaru;
    dataPelanggan[nama].pembayaran_awal = bayarBaru;
    dataPelanggan[nama].harga_modal     = modalBaru;
    dataPelanggan[nama].tanggal_update  = new Date().toLocaleString("id-ID");

    simpanData();
    tampilkanLaporan();
  }

  function hapusData(nama){
    if(!isLoggedIn()){ alert("Login dulu untuk menghapus."); return; }
    if(confirm(`Hapus data ${nama}?`)){
      delete dataPelanggan[nama];
      simpanData();
      tampilkanLaporan();
    }
  }

  // init
  wireNumberFormatting();
  updateAuthUI();
  muatData();
</script>
</body>
</html>

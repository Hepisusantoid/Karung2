<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Pelacakan Penjualan Karung Gadu 2025</title>
  <style>
    body{font-family:Arial, sans-serif;background:#f0f2f5;margin:0;padding:16px;color:#333}
    .container{max-width:780px;margin:0 auto;background:#fff;border-radius:12px;box-shadow:0 6px 18px rgba(0,0,0,.08);padding:20px}
    h1,h2{text-align:center;color:#0a58ca;margin:6px 0 14px}
    /* Auth bar */
    .auth-bar{display:flex;gap:10px;align-items:center;justify-content:flex-end;margin-bottom:12px;flex-wrap:wrap}
    .auth-bar input{flex:1 1 180px;padding:8px 10px;border:1px solid #ddd;border-radius:8px}
    .auth-bar button{padding:10px 14px;border:none;border-radius:8px;color:#fff;background:#0a58ca;cursor:pointer}
    .auth-bar .secondary{background:#6c757d}
    /* Form grid (lebih horizontal) */
    .grid{display:grid;grid-template-columns:repeat(2,1fr);gap:14px}
    @media (max-width:520px){ .grid{grid-template-columns:1fr} }
    label{font-weight:700;margin-bottom:6px;display:block}
    input[type="text"]{width:100%;padding:10px;border:1px solid #ddd;border-radius:8px;font-size:15px;box-sizing:border-box}
    .btn-row{display:flex;gap:12px;margin-top:8px}
    .btn{flex:1;padding:12px;border:none;border-radius:10px;font-size:15px;cursor:pointer;color:#fff;background:#0a58ca}
    .btn:hover{opacity:.93}
    /* Kartu pembeli */
    .data-item{background:#e9f5ff;border-left:6px solid #0d6efd;padding:12px;border-radius:10px;margin:12px 0}
    .lunas{border-color:#28a745;background:#eafff0}
    .belum-lunas{border-color:#dc3545;background:#fff0f0}
    .data-item p{margin:4px 0}
    .uang{font-weight:700;color:#0d6efd}
    .btn-actions{display:flex;gap:10px;margin-top:10px}
    .btn-yellow{background:#ffc107;color:#000}
    .btn-green{background:#28a745}
    .btn-red{background:#dc3545}
    .edit-fields{display:none;margin-top:8px}
    .edit-fields input{margin-bottom:6px}
    /* Laporan keuangan */
    .laporan{margin-top:18px;padding:16px;border:2px solid #8a2be2;border-radius:12px;background:#f8f4ff}
  </style>
</head>
<body>
<div class="container">

  <!-- BAR LOGIN -->
  <div class="auth-bar">
    <input type="password" id="admin_pass" placeholder="Password admin (untuk ubah data)"/>
    <button id="login_btn" onclick="login()">Login</button>
    <button id="logout_btn" class="secondary" style="display:none" onclick="logout()">Keluar</button>
  </div>

  <h1>Gadu 2025</h1>

  <!-- FORM INPUT (tersembunyi bila belum login) -->
  <div id="admin_form" style="display:none">
    <div class="grid">
      <div>
        <label for="nama_pelanggan">Nama</label>
        <input type="text" id="nama_pelanggan" placeholder="cth: Hepi Susanto"/>
      </div>
      <div>
        <label for="kodi_terjual">Kodi</label>
        <input type="text" id="kodi_terjual" value="0"/>
      </div>
      <div>
        <label for="sudah_bayar">Bayar</label>
        <input type="text" id="sudah_bayar" value="0"/>
      </div>
      <div>
        <label for="harga_modal">Modal/Kodi</label>
        <input type="text" id="harga_modal" value="0"/>
      </div>
    </div>
    <div class="btn-row">
      <button class="btn" onclick="tambahData()">Tambah</button>
    </div>
  </div>

  <div id="hasil-penjualan">
    <h2>Laporan Penjualan</h2>
    <div id="daftar_penjualan"></div>
  </div>

  <div id="laporan-keuangan-container" style="display:none;">
    <div class="laporan">
      <h2>Laporan Keuangan</h2>
      <p><strong>Omzet:</strong> <span id="omzet">Rp 0</span></p>
      <p><strong>Total Modal:</strong> <span id="total_modal">Rp 0</span></p>
      <p><strong>Laba Kotor:</strong> <span id="laba_kotor">Rp 0</span></p>
      <p><strong>Laba Bersih:</strong> <span id="laba_bersih">Rp 0</span></p>
    </div>
  </div>

</div>

<script>
  const hargaPerKodi = 45000;
  let dataPelanggan = {};

  /* ===== UTIL ANGKA ===== */
  function formatNumber(num){ if(num==null||isNaN(num)) return "0"; return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g,"."); }
  function parseNumber(str){ return parseInt((str||"0").replace(/\./g,""))||0; }

  // auto-format input angka (kecuali nama)
  function wireNumberFormatting(){
    ["kodi_terjual","sudah_bayar","harga_modal"].forEach(id=>{
      const el=document.getElementById(id);
      if(!el) return;
      el.addEventListener("input",()=>{ el.value = formatNumber(parseNumber(el.value)); });
    });
  }

  /* ====== AUTH (SIMPLE PASSWORD) ====== */
  function isLoggedIn(){ return !!localStorage.getItem("authToken"); }
  function getToken(){ return localStorage.getItem("authToken")||""; }
  function login(){
    const pass = document.getElementById("admin_pass").value.trim();
    if(!pass){ alert("Masukkan password admin."); return; }
    localStorage.setItem("authToken", pass);
    document.getElementById("admin_pass").value="";
    updateAuthUI();
  }
  function logout(){
    localStorage.removeItem("authToken");
    updateAuthUI();
  }
  function updateAuthUI(){
    const logged = isLoggedIn();
    document.getElementById("admin_form").style.display = logged ? "block":"none";
    document.getElementById("login_btn").style.display = logged ? "none":"inline-block";
    document.getElementById("logout_btn").style.display = logged ? "inline-block":"none";
    // toggle tombol Edit/Hapus di kartu
    document.querySelectorAll(".admin-only").forEach(n=> n.style.display = logged ? "" : "none");
  }

  /* ====== BACKEND PROXY (Vercel) ======
     - GET  : /api/get       -> kembalikan object record
     - PUT  : /api/update    -> body { record: {...} }  + Authorization: Bearer <pass>
  ===================================== */

  async function muatData(){
    try{
      const res = await fetch("/api/get");
      const record = await res.json();
      dataPelanggan = record || {};
      // fallback tanggal untuk data lama
      Object.keys(dataPelanggan).forEach(n=>{
        if(!dataPelanggan[n].tanggal_update) dataPelanggan[n].tanggal_update = "-";
      });
      tampilkanLaporan();
    }catch(e){
      console.error("Gagal muat:", e);
      alert("Gagal memuat data.");
    }
  }

  async function simpanData(){
    if(!isLoggedIn()){ alert("Silakan login dulu untuk menyimpan perubahan."); return; }
    try{
      const res = await fetch("/api/update",{
        method:"PUT",
        headers:{
          "Content-Type":"application/json",
          "Authorization":"Bearer "+getToken()
        },
        body: JSON.stringify({ record: dataPelanggan })
      });
      if(res.status===401||res.status===403){
        alert("Password admin salah / tidak berhak.");
        return;
      }
      if(!res.ok){
        const t = await res.text();
        console.error("Gagal simpan:", t);
        alert("Gagal menyimpan data.");
      }
    }catch(e){
      console.error("Gagal simpan:", e);
      alert("Gagal menyimpan data.");
    }
  }

  /* ====== FITUR APLIKASI (KONSISTEN) ====== */

  function tambahData(){
    if(!isLoggedIn()){ alert("Login dulu untuk menambah data."); return; }

    const nama = document.getElementById("nama_pelanggan").value.trim();
    const kodi = parseNumber(document.getElementById("kodi_terjual").value);
    const bayar = parseNumber(document.getElementById("sudah_bayar").value);
    const modal = parseNumber(document.getElementById("harga_modal").value);

    if(!nama || kodi<=0){ alert("Isi nama & kodi yang valid."); return; }

    dataPelanggan[nama] = {
      kodi_terjual: kodi,
      pembayaran_awal: bayar,
      harga_modal: modal,
      tanggal_update: new Date().toLocaleString("id-ID")
    };
    simpanData();
    tampilkanLaporan();

    document.getElementById("nama_pelanggan").value="";
    document.getElementById("kodi_terjual").value="0";
    document.getElementById("sudah_bayar").value="0";
    document.getElementById("harga_modal").value="0";
  }

  function tampilkanLaporan(){
    const wrap = document.getElementById("daftar_penjualan");
    wrap.innerHTML = "";

    let totalOmzet=0, totalUtang=0, totalModal=0;

    const arr = Object.keys(dataPelanggan).map(k=>({nama:k, data:dataPelanggan[k]}));
    // Belum lunas di atas
    arr.sort((a,b)=>{
      const sA = (a.data.kodi_terjual*hargaPerKodi)-a.data.pembayaran_awal;
      const sB = (b.data.kodi_terjual*hargaPerKodi)-b.data.pembayaran_awal;
      if(sA>0 && sB<=0) return -1;
      if(sA<=0 && sB>0) return 1;
      return 0;
    });

    arr.forEach(({nama,data})=>{
      const totalTagihan = data.kodi_terjual * hargaPerKodi;
      const sisaUtang = totalTagihan - data.pembayaran_awal;
      const statusClass = sisaUtang>0 ? "belum-lunas":"lunas";
      const statusText  = sisaUtang>0 ? "Belum Lunas":"Lunas";

      totalOmzet += totalTagihan;
      totalUtang += sisaUtang;
      totalModal += data.kodi_terjual * data.harga_modal;

      const el = document.createElement("div");
      el.className = `data-item ${statusClass}`;
      el.setAttribute("data-nama", nama);
      el.innerHTML = `
        <p><strong>Nama:</strong> ${nama}</p>
        <p><strong>Kodi:</strong> ${formatNumber(data.kodi_terjual)}</p>
        <p><strong>Total Bayar:</strong> <span class="uang">Rp ${formatNumber(totalTagihan)}</span></p>
        <p><strong>Sudah Bayar:</strong> <span class="uang">Rp ${formatNumber(data.pembayaran_awal)}</span></p>
        <p><strong>Sisa Utang:</strong> <span class="uang">Rp ${formatNumber(sisaUtang)}</span></p>
        <p><strong>Status:</strong> ${statusText}</p>
        <p><strong>Tanggal Update:</strong> ${data.tanggal_update || "-"}</p>

        <div class="btn-actions admin-only" style="${isLoggedIn()?"":"display:none"}">
          <button class="btn-yellow" onclick="toggleEdit('${nama}')">Edit</button>
          <button class="btn-green"  style="display:none" onclick="simpanEdit('${nama}')">Simpan</button>
          <button class="btn-red"    onclick="hapusData('${nama}')">Hapus</button>
        </div>

        <div class="edit-fields">
          <input type="text" class="edit-kodi"  value="${formatNumber(data.kodi_terjual)}" placeholder="Kodi"/>
          <input type="text" class="edit-bayar" value="${formatNumber(data.pembayaran_awal)}" placeholder="Sudah Bayar"/>
          <input type="text" class="edit-modal" value="${formatNumber(data.harga_modal)}" placeholder="Modal/Kodi"/>
        </div>
      `;
      wrap.appendChild(el);

      // wiring formatter untuk input edit di kartu
      el.querySelectorAll(".edit-kodi,.edit-bayar,.edit-modal").forEach(inp=>{
        inp.addEventListener("input", ()=>{ inp.value = formatNumber(parseNumber(inp.value)); });
      });
    });

    const labaKotor = totalOmzet - totalModal;
    const labaBersih = labaKotor - totalUtang;

    document.getElementById("omzet").innerText       = "Rp " + formatNumber(totalOmzet);
    document.getElementById("total_modal").innerText = "Rp " + formatNumber(totalModal);
    document.getElementById("laba_kotor").innerText  = "Rp " + formatNumber(labaKotor);
    document.getElementById("laba_bersih").innerText = "Rp " + formatNumber(labaBersih);
    document.getElementById("laporan-keuangan-container").style.display = "block";
  }

  function toggleEdit(nama){
    const card = document.querySelector(`.data-item[data-nama="${nama}"]`);
    card.querySelector(".edit-fields").style.display="block";
    const [btnEdit, btnSimpan] = card.querySelectorAll(".btn-actions button");
    btnEdit.style.display="none"; btnSimpan.style.display="inline-block";
  }

  function simpanEdit(nama){
    if(!isLoggedIn()){ alert("Login dulu untuk menyimpan."); return; }
    const card = document.querySelector(`.data-item[data-nama="${nama}"]`);
    const kodiBaru  = parseNumber(card.querySelector(".edit-kodi").value);
    const bayarBaru = parseNumber(card.querySelector(".edit-bayar").value);
    const modalBaru = parseNumber(card.querySelector(".edit-modal").value);
    if(kodiBaru<=0){ alert("Kodi harus > 0"); return; }

    dataPelanggan[nama].kodi_terjual    = kodiBaru;
    dataPelanggan[nama].pembayaran_awal = bayarBaru;
    dataPelanggan[nama].harga_modal     = modalBaru;
    dataPelanggan[nama].tanggal_update  = new Date().toLocaleString("id-ID");

    simpanData();
    tampilkanLaporan();
  }

  function hapusData(nama){
    if(!isLoggedIn()){ alert("Login dulu untuk menghapus."); return; }
    if(confirm(`Hapus data ${nama}?`)){
      delete dataPelanggan[nama];
      simpanData();
      tampilkanLaporan();
    }
  }

  // init
  wireNumberFormatting();
  updateAuthUI();
  muatData();
</script>
</body>
  </html>
